name: Build & Security Check

on:
  push:
    branches: [ main, master, develop ]
  pull_request:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for better secret detection

      - name: Ensure .gitignore exists
        run: |
          echo "üìù Checking for .gitignore file..."
          if [ ! -f .gitignore ]; then
            echo "‚ö†Ô∏è  No .gitignore found, creating one..."
            cat > .gitignore << 'GITIGNORE_EOF'
          # Dependencies
          node_modules/
          vendor/

          # Environment and secrets
          .env
          .env.local
          .env.*.local
          *.key
          *.pem
          *.p12
          *.pfx
          *secret*
          *password*
          *credentials*
          config/secrets.yml
          config/database.yml

          # IDE
          .vscode/
          .idea/
          *.swp
          *.swo
          *~

          # OS
          .DS_Store
          Thumbs.db

          # Build outputs
          dist/
          build/
          *.log
          GITIGNORE_EOF
            echo "‚úÖ Created default .gitignore"
          else
            echo "‚úÖ .gitignore exists"
          fi

      - name: Install Gitleaks
        run: |
          echo "üì¶ Installing Gitleaks for secret scanning..."
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/

      - name: Scan for secrets
        id: gitleaks
        run: |
          echo "üîç Scanning repository for secrets..."
          if gitleaks detect --no-git --report-path gitleaks-report.json -v; then
            echo "‚úÖ No secrets detected"
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  SECRETS DETECTED!"
            echo "secrets_found=true" >> $GITHUB_OUTPUT

            # Extract file paths with secrets
            if [ -f gitleaks-report.json ]; then
              echo "üìã Files with secrets:"
              jq -r '.[].File' gitleaks-report.json | sort -u | tee secret-files.txt
            fi
          fi

      - name: Update .gitignore with secret files
        if: steps.gitleaks.outputs.secrets_found == 'true'
        run: |
          echo "üîí Adding files with secrets to .gitignore..."

          if [ -f secret-files.txt ]; then
            while IFS= read -r file; do
              # Add file to .gitignore if not already there
              if ! grep -qF "$file" .gitignore 2>/dev/null; then
                echo "$file" >> .gitignore
                echo "  Added: $file"
              fi
            done < secret-files.txt

            echo ""
            echo "‚ö†Ô∏è  IMPORTANT: The following files contain secrets and have been added to .gitignore:"
            cat secret-files.txt
            echo ""
            echo "‚ö†Ô∏è  You must remove these files from git history using:"
            echo "   git rm --cached <file>"
            echo "   git commit -m 'Remove files with secrets'"
            echo ""
          fi

      - name: Report .gitignore recommendations
        if: steps.gitleaks.outputs.secrets_found == 'true'
        run: |
          # NOTE: We intentionally do NOT auto-commit .gitignore changes
          # This prevents out-of-sync issues with local development copies
          # Developers should manually add the recommended entries

          if ! git diff --quiet .gitignore 2>/dev/null; then
            echo ""
            echo "üìã RECOMMENDED .gitignore additions:"
            echo "======================================"
            git diff .gitignore || true
            echo ""
            echo "‚ö†Ô∏è  Please add these entries to your .gitignore manually and commit."
            echo "    This ensures your local copy stays in sync."
          fi

      - name: Fail if secrets found
        if: steps.gitleaks.outputs.secrets_found == 'true'
        run: |
          echo "‚ùå BUILD FAILED: Secrets detected in repository"
          echo ""
          echo "üîí Secret files have been added to .gitignore"
          echo "üìù Please review the files listed above and remove any committed secrets"
          echo "üîÑ After fixing, commit and push again"
          exit 1

  build:
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js (if applicable)
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        if: hashFiles('package.json') != ''
        run: npm ci || npm install

      - name: Check for vulnerabilities
        if: hashFiles('package.json') != ''
        run: npm audit --audit-level=high || true

      - name: Build
        if: hashFiles('package.json') != ''
        run: |
          if grep -q '"build"' package.json; then
            npm run build
          fi

      - name: Run tests
        if: hashFiles('package.json') != ''
        run: |
          if grep -q '"test"' package.json; then
            npm test
          fi

      - name: Mark as stable
        run: |
          echo "‚úÖ BUILD STATUS: STABLE"
          echo "All checks passed successfully"

      - name: Trigger sync to GitHub
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo "üîÑ Triggering sync to GitHub..."
          REPO_NAME=${GITHUB_REPOSITORY#*/}
          curl -X POST http://home-git-sync-service:48563/api/sync/gitea-to-github \
            -H "Content-Type: application/json" \
            -d "{\"repoName\": \"$REPO_NAME\"}" \
            || echo "‚ö†Ô∏è  Sync trigger failed, will sync on next scheduled run"
